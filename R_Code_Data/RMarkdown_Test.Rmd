---
title: RMarkdown for "Variations in Structural MRI Quality Significantly Impacts Commonly-Used
  Measures of Brain Anatomy"
author: "Jamie Hanson"
date: "4/25/2020"
output:
html_document:
theme: cerulean
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

\
\
# Starting Steps \
First, we load relevant libraries, needed for various operations (using the pacman library).

```{r library}

library(pacman)
pacman::p_load(table1, car, pROC, rcompanion, ggplot2, corrplot, knitr, kableExtra)

```

\
\
Next, load data (from the related/included csv file)

```{r load data}

combined<-read.csv("combined_data.csv")

```

\
\
# Methods \
For elements our methods section, we note sample demographics, means. etc. This is related to **Methods Section 2.5**. First, we recode and rename variables to make naming more appropriate for table 1 (the R library).\
\
Notes re: variables-- \
-Basic_Demos.Sex = Participant Sex (coded Male / Female) \
-Diagnosis_ClinicianConsensus.NoDX  = Participant Clinical Diagnoses (coded as No / Yes) \
-Basic_Demos.Age = Participant Age (coded in # of years) \
-WISC.WISC_FSIQ = Participant Wechsler Intelligence Scale for Children, Full Scale IQ  (continuous measure) \
-Physical.BMI = Participant BMI (continuous measure) \
-CAT12_QC_Weighted_Average = MRI Quality Rating (continuous measure) \
\

```{r recode data}

combined$Basic_Demos.Sex<-car::recode(combined$Basic_Demos.Sex,'0="Male";1="Female"')

combined$Diagnosis_ClinicianConsensus.NoDX<-car::recode(combined$Diagnosis_ClinicianConsensus.NoDX,'1="No History";2="One or more Disorder"')

combined$Sex<-as.factor(combined$Basic_Demos.Sex)

combined$Age<-as.numeric(combined$Basic_Demos.Age)

combined$Diagnosis<-as.factor(combined$Diagnosis_ClinicianConsensus.NoDX)

combined$IQ<-as.numeric(combined$WISC.WISC_FSIQ)

combined$BMI<-as.numeric(combined$Physical.BMI)

combined$StructuralMRIQuality<-as.numeric(combined$CAT12_QC_Weighted_Average)

```

\
\
Construction of **Table 1** (via table1 R package)
```{r generate table 1}

table1(~ Sex + Age + Diagnosis + IQ + BMI + StructuralMRIQuality, data=combined)

```

\
\
# Results \
Analyses related to CAT 12 QC Ratings, and Passing [yes/no]. This is related to **Results, Section 4.1**

```{r Results related to Quality Control and Passing Visual Checks}

summary(model_CAT12_pass<-glm(passing~ CAT12_QC_Weighted_Average , family = "binomial", data=combined))

```
 
```{r Partial R-Squared for that model}

nagelkerke(model_CAT12_pass)

```

\
\
We also completed a Bayesian GLM, as a supplemental analysis (given the warning message in the above "frequentist" GLM \

```{r bayesian logistic model, as a check}

suppressMessages(library(arm))
summary(bayesglm(passing ~ CAT12_QC_Weighted_Average, data=combined, family="binomial"))

```

\
\
Generating **Figure 1** (ROC Curve with confidence intervals)

```{r Generating Figure 1 ROC Curve}

roc<-plot.roc(combined$passing, combined$CAT12_QC_Weighted_Average,main = "Confidence intervals", percent=TRUE,ci = TRUE,print.auc = TRUE, asp = NA,direction="auto")  

ciobj <- ci.se(roc,specificities = seq(0, 100, 5)) 
plot(ciobj, type = "shape", col = "red")

```

\
\
Results for relations between sociodemographics and MRI Quality, **Results, Section 4.2**

```{r Relations between age and MRI Quality}

summary(lm(CAT12_QC_Weighted_Average~ combined$Basic_Demos.Age , data=combined))

lm.beta::lm.beta(lm(CAT12_QC_Weighted_Average~ combined$Basic_Demos.Age , data=combined))

```

\
\
Generating **Figure 2** (scatterplot of age and MRI Quality)

```{r scatterplot of age and MRI Quality}

ggplot(combined, aes(y=CAT12_QC_Weighted_Average, x=Basic_Demos.Age)) +geom_point(shape=16, size=3,color = 'black',alpha = 0.5) + geom_smooth(method=lm, color = 'red') 

```

\
\
Additional Tests in **Results, Section 4.2** (all non-significant)

```{r Additional Tests between Person-Level Variables and MRI Quality}

summary(lm(CAT12_QC_Weighted_Average~ combined$Basic_Demos.Sex , data=combined))

summary(lm(CAT12_QC_Weighted_Average~ combined$WISC.WISC_FSIQ , data=combined))

lm.beta::lm.beta(lm(CAT12_QC_Weighted_Average~ combined$WISC.WISC_FSIQ , data=combined))

summary(lm(CAT12_QC_Weighted_Average~ combined$Physical.BMI , data=combined))

summary(lm(CAT12_QC_Weighted_Average~ combined$Diagnosis_ClinicianConsensus.NoDX , data=combined))

```

\
\
Additional Analyses in **Results, Section 4.2** (only the subjects that pass visual inspection)

```{r Additional Tests with only passers}

OnlySubsPassingVisualQC<-subset(combined,combined$passing==1)

summary(lm(CAT12_QC_Weighted_Average~ Basic_Demos.Age , data=OnlySubsPassingVisualQC))

summary(lm(CAT12_QC_Weighted_Average~ Basic_Demos.Sex , data=OnlySubsPassingVisualQC))

summary(lm(CAT12_QC_Weighted_Average~ WISC.WISC_FSIQ , data=OnlySubsPassingVisualQC))

summary(lm(CAT12_QC_Weighted_Average~ Physical.BMI , data=OnlySubsPassingVisualQC))

summary(lm(CAT12_QC_Weighted_Average~ factor(Diagnosis_ClinicianConsensus.NoDX) , data=OnlySubsPassingVisualQC))

```

\
\
Results for relations between Freesurfer Outputs and MRI Quality, **Results, Section 4.3**. We complete some looped regressions, save relevant statistics, multiple-comparison correction, and then prep for Figure construction.\

```{r Relations between Freesurfer Outputs and MRI Quality}

library(ggseg); library(ggseg3d); library(tidyverse); library(stringr); library(ggsci)

combined_ONLY_passing<-subset(combined,combined$passing==1 & combined$brain.stem!="NA")
Only_Freesurfer_Data<-combined_ONLY_passing[,7:90]
Only_CAT12_QC_Weighted_Average<-data.frame(combined_ONLY_passing$CAT12_QC_Weighted_Average)

n<-84
Loop_to_Extract_Tstats <- lapply(1:n, function(x) lm(Only_Freesurfer_Data[,x] ~ Only_CAT12_QC_Weighted_Average[,1]))
summaries <- lapply(Loop_to_Extract_Tstats, summary)
saved_t_statistics<-lapply(summaries, function(x) x$coefficients[, c(3)])
saved_pvalue<-lapply(summaries, function(x) x$coefficients[, c(4)])

T_Statistics_temp<-lapply(saved_t_statistics, function (x) x[c('Only_CAT12_QC_Weighted_Average[, 1]')])
T_Statistics<-do.call(rbind.data.frame, T_Statistics_temp)

P_Value_temp<-lapply(saved_pvalue, function (x) x[c('Only_CAT12_QC_Weighted_Average[, 1]')])
Pvalue<-do.call(rbind.data.frame, P_Value_temp)
names(Pvalue)[names(Pvalue)=="c.0.0362567175922178..0.0156777311878222..0.104426644108848.."] <- "p_value"

P_value_adjusted<-data.frame(round(p.adjust(Pvalue$p_value, method = "BH", n = length(Pvalue$p_value)),4))

Brain_Areas<-colnames(Only_Freesurfer_Data)
DataFrameForFigure<-data.frame(Brain_Areas,T_Statistics,P_value_adjusted)
names(DataFrameForFigure)[names(DataFrameForFigure)=="c.2.10801383427631..2.4368470062469..1.63106691579897..2.31388238512456.."] <- "t_stats"
names(DataFrameForFigure)[names(DataFrameForFigure)=="round.p.adjust.Pvalue.p_value..method....BH...n...length.Pvalue.p_value...."] <- "p_value_adjusted"

Significant<-subset(DataFrameForFigure,DataFrameForFigure$p_value_adjusted<.05)

```

\
\
Making **Figure 3** (Cortical Freesurfer Outputs, Related to MRI Quality)\

```{r Figure 3}

Only_Cortex<-Significant[7:37,]
Only_Cortex_Filenames<-as.character(Only_Cortex$Brain_Areas)
Only_Cortex_t_stats<-Only_Cortex$t_stats

cortical_statistical_values= tibble(label=c(Only_Cortex_Filenames),t=c(Only_Cortex_t_stats))

cortical_statistical_values %>% ggseg(mapping=aes(fill=t),colour="black",position = "stacked")+ scale_fill_gradientn(limits = c(-6,6),colours = c("cornflowerblue","white","red1"),na.value="grey")

```

\
\
Making **Figure 4** (Subcortical Freesurfer Outputs, Related to MRI Quality)\

```{r Figure 4}

Only_Subcortex<-Significant[1:6,]
Only_Subcortex_Filenames<-as.character(Only_Subcortex$Brain_Areas)
Only_Subcortex_Filenames <- str_replace_all(Only_Subcortex_Filenames, "[.]", "-")
Only_Subcortex_t_stats<-Only_Subcortex$t_stats

aseg_statistical_values= tibble(label=c(Only_Subcortex_Filenames),t=c(Only_Subcortex_t_stats))

aseg_statistical_values %>% 
ggseg(mapping=aes(fill=t),colour="black",atlas=aseg)+ scale_fill_gradientn(limits = c(-3.5,3.5),colours = c("cornflowerblue","white","red1"),na.value="grey")

```

\
\
Output **Table 2** Listing all regions related to MRI Quality \

```{r Table 2}

library(knitr); library(kableExtra); library(magick); library(webshot)

row.names(Significant) <- NULL
kable(Significant, "latex", booktabs = T) %>%
as_image()

```

Output **Figure 5** (two panels) \

```{r Figure 5}

#5A
ggplot(combined_ONLY_passing, aes(y=CAT12_QC_Weighted_Average, x=lh_caudalmiddlefrontal)) +geom_point(shape=16, size=3,color = 'black',alpha = 0.5) + geom_smooth(method=lm, color = 'red') 

#5B
ggplot(combined_ONLY_passing, aes(y=CAT12_QC_Weighted_Average, x=Left.Amygdala)) +geom_point(shape=16, size=3,color = 'black',alpha = 0.5) + geom_smooth(method=lm, color = 'red') 

```


\
\